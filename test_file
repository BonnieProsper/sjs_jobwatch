from dataclasses import replace
from datetime import datetime, timezone

from sjs_sitewatch.domain.job import Job
from sjs_sitewatch.domain.snapshot import Snapshot
from sjs_sitewatch.domain.diff import diff_snapshots
from sjs_sitewatch.domain.explain import explain_job_change, job_change_severity


def make_job(**overrides) -> Job:
    now = datetime.now(tz=timezone.utc)

    base = Job(
        id="1",
        title="Junior Engineer",
        employer="ABC Corp",
        summary="Old summary",
        description="Desc",
        category="ICT",
        classification="IT",
        sub_classification="Software",
        job_type="Full Time",
        area="Remote",
        pay_min=80000,
        pay_max=100000,
        posted_date=now,
        start_date=None,
        end_date=None,
        region="NZ",
    )

    return replace(base, **overrides)


# ─────────────────────────────────────────────
# Create two snapshots
# ─────────────────────────────────────────────

old_job = make_job()
new_job = make_job(
    title="Senior Engineer",
    pay_max=130000,
)

previous = Snapshot(
    jobs={"1": old_job},
    captured_at=datetime.now(tz=timezone.utc),
)

current = Snapshot(
    jobs={"1": new_job},
    captured_at=datetime.now(tz=timezone.utc),
)

# ─────────────────────────────────────────────
# Diff + explain
# ─────────────────────────────────────────────

diff = diff_snapshots(previous.jobs, current.jobs)

print("Modified jobs:", len(diff.modified))

for change in diff.modified:
    print(f"\nJob ID: {change.job_id}")
    print("Severity:", job_change_severity(change).value)

    for line in explain_job_change(change):
        print(" -", line)
